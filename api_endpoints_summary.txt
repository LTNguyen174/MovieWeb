# REST API endpoints (extracted from project)

---

### Conventions used below
- Base API root is `/api/` (set in `movie_project/urls.py`).
- Movie router is the DRF `DefaultRouter()` registered in `movies/urls.py`. That means standard REST list/retrieve/create/... routes are under `/api/<router-prefix>/`.
- `MovieViewSet.lookup_field = 'tmdb_id'` — movie retrieve URLs use the TMDB id (not internal PK).
- Authentication/permission notes are included for each endpoint.
- Example request/response bodies are inferred from serializers in `movies/serializers.py` and `users/serializers.py`. Dates/times shown as ISO strings.

---

## Movies app endpoints (prefix: /api/)

### GET /api/movies/
- Method: GET
- Auth: Allowed for anonymous users (IsAuthenticatedOrReadOnly)
- Description: List movies (paginated by DRF defaults). Uses `MovieSerializer` (summary fields).
- Query params:
  - `search=<text>` — full-text search on movie title (DRF SearchFilter).
  - `categories=<id>` — filter by category id (can be repeated depending on client).
  - `release_year=<year>` — filter by release year.
- Example response (list item; MovieSerializer):

```json
[
  {
    "title": "The Example Movie",
    "poster": "https://image.tmdb.org/t/p/w500/abcd.jpg",
    "release_year": 2020,
    "tmdb_id": 12345,
    "categories": [
      {"id": 1, "name": "Action"}
    ]
  },
  ...
]
```

### GET /api/movies/{tmdb_id}/
- Method: GET
- Auth: Allowed for anonymous users
- Description: Retrieve movie details. Uses `MovieDetailSerializer`.
- Example response (MovieDetailSerializer):

```json
{
  "tmdb_id": 12345,
  "title": "The Example Movie",
  "description": "A long description...",
  "poster": "https://image.tmdb.org/t/p/w500/abcd.jpg",
  "release_year": 2020,
  "categories": [{"id":1,"name":"Action"}],
  "average_rating": 4.2
}
```

### GET /api/movies/{tmdb_id}/comments/
- Method: GET
- Auth: MovieViewSet permits read for anonymous (IsAuthenticatedOrReadOnly) — but note `CommentViewSet` elsewhere requires authentication; this per-movie action uses `CommentSerializer` and returns comments for that movie.
- Description: Returns comments attached to the movie (ordered by newest).
- Example response:

```json
[
  {
    "id": 77,
    "username": "alice",
    "content": "Loved the soundtrack!",
    "created_at": "2025-10-15T12:34:56Z"
  },
  ...
]
```

### POST /api/movies/{tmdb_id}/rate/
- Method: POST
- Auth: Requires authentication (permission_classes on action = IsAuthenticated)
- Description: Create or update the authenticated user's rating for the movie. Accepts `stars` integer.
- Request example:

```json
{
  "stars": 5
}
```
- Response example:

```json
{
  "status": "rating saved"
}
```
- Possible responses: `201 Created` on save, `400 Bad Request` on invalid stars.

### POST /api/movies/{tmdb_id}/increment_view/
- Method: POST
- Auth: Allows any user (permission_classes on action = AllowAny)
- Description: Increment the movie's `views` by 1. Returns current total views.
- Request body: none required.
- Response example:

```json
{
  "status": "view incremented",
  "total_views": 1245
}
```

### GET /api/movies/{tmdb_id}/recommendations/
- Method: GET
- Auth: Allowed for anonymous users
- Description: Returns up to ~10 recommended movies that share categories with the given movie; ordered by shared category count and views. Uses `MovieSerializer`.
- Response example: same shape as MovieSerializer list (see /api/movies/).

---

## Categories endpoints (prefix: /api/categories/)

### GET /api/categories/
- Method: GET
- Auth: AllowAny
- Description: List all categories. Uses `CategorySerializer`.
- Response example:

```json
[
  {"id":1,"name":"Action"},
  {"id":2,"name":"Drama"}
]
```

### GET /api/categories/{pk}/
- Method: GET
- Auth: AllowAny
- Description: Retrieve a single category by PK.
- Response example:

```json
{"id":1,"name":"Action"}
```

---

## Comments endpoints (prefix: /api/comments/)

`CommentViewSet` is a ModelViewSet registered as `comments` on the router.

### GET /api/comments/
- Method: GET
- Auth: The view's `permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]` — currently that combination requires authenticated users for all actions (read included). So authenticated users can list comments.
- Description: List comments (global) — the serializer used for list is `CommentSerializer` (includes username).
- Response example:

```json
[
  {"id": 77, "username": "alice", "content": "Nice plot", "created_at": "2025-10-15T12:34:56Z"},
  ...
]
```

### POST /api/comments/
- Method: POST
- Auth: Requires authentication (IsAuthenticated)
- Description: Create a comment. `CommentCreateSerializer` expects `movie_tmdb_id` (write-only) and `content`. `perform_create` maps `movie_tmdb_id` to the internal Movie and saves `user` from request.
- Request example:

```json
{
  "movie_tmdb_id": 12345,
  "content": "Great movie!"
}
```
- Response: The view uses the create serializer; typical behavior is the created resource will be returned (clients should expect a comment representation). Example response (read-style):

```json
{
  "id": 512,
  "username": "bob",
  "content": "Great movie!",
  "created_at": "2025-11-07T09:00:00Z"
}
```
(Implementations may return the `create` serializer data, but the created/read representation is the practical expectation.)

### GET /api/comments/{pk}/
- Method: GET
- Auth: Requires authentication (per `permission_classes`)
- Description: Retrieve one comment (read serializer returns `username`).

### PUT/PATCH /api/comments/{pk}/
- Method: PUT or PATCH
- Auth: Requires authenticated & owner (IsOwnerOrReadOnly enforces that only the owner can modify).
- Request example (update content):

```json
{
  "content": "Updated comment text"
}
```
- Response: updated comment representation.

### DELETE /api/comments/{pk}/
- Method: DELETE
- Auth: Requires authenticated & owner
- Description: Delete comment.

---

## Admin-style endpoints (mounted at /api/admin/... from `movies/urls.py` admin_patterns)

> These are registered manually in `movies/urls.py`:
> - `path('stats/', DashboardStatsView.as_view(), name='admin-stats')`
> - `path('fetch-tmdb/', FetchTMDBView.as_view(), name='admin-fetch-tmdb')`
> - `path('import-tmdb/', ImportTMDBView.as_view(), name='admin-import-tmdb')`

All admin endpoints require the user to be an admin (`IsAdminUser`).

### GET /api/admin/stats/
- Method: GET
- Auth: Admin only
- Description: Returns simple dashboard statistics: counts of users, movies, comments, and total movie views.
- Response example:

```json
{
  "user_count": 128,
  "movie_count": 5123,
  "comment_count": 2345,
  "total_views": 789012
}
```

### GET /api/admin/fetch-tmdb/?search={query}
- Method: GET
- Auth: Admin only
- Description: Proxy search to TMDB (server-side call) to fetch matching movies. Query param: `search`.
- Example request: `GET /api/admin/fetch-tmdb/?search=terminator`
- Example response (list of simplified TMDB results):

```json
[
  {
    "tmdb_id": 101,
    "title": "The Terminator",
    "poster_path": "/poster.jpg",
    "release_date": "1984-10-26"
  },
  ...
]
```
- Errors: `400` if `search` missing, `500` on TMDB call failure.

### POST /api/admin/import-tmdb/
- Method: POST
- Auth: Admin only
- Description: Server fetch of a single movie by its TMDB id and import into local DB using `import_movie_from_tmdb` (in `movies/tmdb_service.py`). If movie already exists, returns `409 Conflict`.
- Request example:

```json
{
  "tmdb_id": 12345
}
```
- Success response: serialized `MovieDetailSerializer` (see movie detail example) with `201 Created`.
- Error responses: `400` if missing tmdb_id, `409` if already exists, `500` for other errors.

---

## Users / Authentication endpoints (prefix: /api/auth/)

### POST /api/auth/register/
- Method: POST
- Auth: AllowAny
- Description: Register a new user. Uses `RegisterSerializer` which requires `username`, `email`, `password`.
- Request example:

```json
{
  "username": "alice",
  "email": "alice@example.com",
  "password": "s3cr3t"
}
```
- Response example: created user object (fields depend on `RegisterSerializer` output — often `username` and `email`).

### POST /api/auth/login/
- Method: POST
- Auth: AllowAny
- Description: JWT login (DRF SimpleJWT `TokenObtainPairView`). Expect `username` and `password`. Returns `access` and `refresh` tokens.
- Request:

```json
{
  "username": "alice",
  "password": "s3cr3t"
}
```
- Response:

```json
{
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOi...",
  "access": "eyJ0eXAiOiJKV1QiLCJhbGciOi..."
}
```

### POST /api/auth/login/refresh/
- Method: POST
- Auth: AllowAny
- Description: Refresh access token with a `refresh` token.
- Request:

```json
{"refresh": "<refresh token>"}
```
- Response:

```json
{"access": "<new access token>"}
```

### GET /api/auth/profile/favorites/
- Method: GET
- Auth: Requires authentication (IsAuthenticated)
- Description: Lists the authenticated user's ratings (favorite list). Uses `UserRatingSerializer` which includes a nested `movie` object (MovieSerializer), `stars`, and `created_at`.
- Response example:

```json
[
  {
    "movie": {
      "title": "The Example Movie",
      "poster": "https://image.tmdb.org/t/p/w500/abcd.jpg",
      "release_year": 2020,
      "tmdb_id": 12345,
      "categories": [{"id":1,"name":"Action"}]
    },
    "stars": 5,
    "created_at": "2025-10-01T08:00:00Z"
  },
  ...
]
```

### GET /api/auth/profile/comments/
- Method: GET
- Auth: Requires authentication
- Description: Lists comments created by the authenticated user. Returns items using `CommentSerializer`.
- Response example:

```json
[
  {"id": 77, "username": "alice", "content": "I liked it", "created_at": "2025-10-15T12:34:56Z"},
  ...
]
```

### PUT /api/auth/profile/change-password/
- Method: PUT
- Auth: Requires authentication
- Description: Change password for the authenticated user. Uses `ChangePasswordSerializer` expecting `old_password`, `new_password`, `new_password_confirm`. Validates old password and matching new passwords.
- Request example:

```json
{
  "old_password": "old123",
  "new_password": "newSecret1",
  "new_password_confirm": "newSecret1"
}
```
- Success response:

```json
{"status": "Đổi mật khẩu thành công."}
```
- Error responses: `400` with `old_password` error if old password incorrect or validation errors for new passwords.

---

## Admin CRUD endpoints (prefix: /api/admin/)

> These are registered in the router for full CRUD operations on models.
> All admin endpoints require the user to be an admin (`IsAdminUser`).

### GET/POST /api/admin/movies/
- Method: GET/POST
- Auth: Admin only
- Description: List all movies (GET) or create new movie (POST). Uses `AdminMovieSerializer`.
- GET response: Full movie data with all fields.
- POST request: Full movie object data.

### GET/PUT/DELETE /api/admin/movies/{pk}/
- Method: GET/PUT/DELETE
- Auth: Admin only
- Description: Retrieve, update, or delete a specific movie.

### GET/POST /api/admin/categories/
- Method: GET/POST
- Auth: Admin only
- Description: List all categories (GET) or create new category (POST).

### GET/PUT/DELETE /api/admin/categories/{pk}/
- Method: GET/PUT/DELETE
- Auth: Admin only
- Description: Retrieve, update, or delete a specific category.

### GET/POST /api/admin/actors/
- Method: GET/POST
- Auth: Admin only
- Description: List all actors (GET) or create new actor (POST).

### GET/PUT/DELETE /api/admin/actors/{pk}/
- Method: GET/PUT/DELETE
- Auth: Admin only
- Description: Retrieve, update, or delete a specific actor.

### GET/POST /api/admin/countries/
- Method: GET/POST
- Auth: Admin only
- Description: List all countries (GET) or create new country (POST).

### GET/PUT/DELETE /api/admin/countries/{pk}/
- Method: GET/PUT/DELETE
- Auth: Admin only
- Description: Retrieve, update, or delete a specific country.

### GET/POST /api/admin/users/
- Method: GET/POST
- Auth: Admin only
- Description: List all users (GET) or create new user (POST).

### GET/PUT/DELETE /api/admin/users/{pk}/
- Method: GET/PUT/DELETE
- Auth: Admin only
- Description: Retrieve, update, or delete a specific user.

### GET/POST /api/admin/comments/
- Method: GET/POST
- Auth: Admin only
- Description: List all comments (GET) or create new comment (POST).

### GET/PUT/DELETE /api/admin/comments/{pk}/
- Method: GET/PUT/DELETE
- Auth: Admin only
- Description: Retrieve, update, or delete a specific comment.

### GET/POST /api/admin/episodes/
- Method: GET/POST
- Auth: Admin only
- Description: List all episodes (GET) or create new episode (POST). Uses `EpisodeSerializer`.

### GET/PUT/DELETE /api/admin/episodes/{pk}/
- Method: GET/PUT/DELETE
- Auth: Admin only
- Description: Retrieve, update, or delete a specific episode.

---

